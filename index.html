<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>텍스트 & 이미지 오디오북 변환기</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>
    <!-- XLSX for Excel file reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container panel-collapsed"> <!-- panel-collapsed 클래스 추가 -->
        <header>
            <h1>오디오북 메이커 (TTS / OCR 지원)</h1>
        </header>

        <!-- 메인 콘텐츠를 감싸는 유연한 컨테이너 -->
        <div class="main-flex-container">

            <div id="left_panel">
                <div class="file-management-section">
                    <h2>파일 관리 및 첨부</h2>
                    <div id="drop-area">
                        <p>여기에 텍스트, 이미지, PDF, 엑셀 파일을 드래그 & 드롭하거나 클릭하여 첨부하세요 (최대 50개)</p>
                        <input type="file" id="file-input" accept=".txt,.pdf,.jpg,.jpeg,.png,.gif,.webp,.tiff,.tif,.xlsx,.xls,.csv" multiple style="display: none;">
                        <ul id="file-list"></ul>
                    </div>

                    <div class="control-section">
                        <label for="voice-select">목소리 선택:</label>
                        <select id="voice-select"></select>
                        <label for="rate-slider">재생 속도:</label>
                        <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1">
                        <span id="rate-display">1</span>
                        <div class="playback-controls"> 
                            <button id="play-pause-btn">▶️</button>
                            <button id="stop-btn">⏹️</button>
                            <button id="prev-file-btn">⏮️</button>
                            <button id="next-file-btn">⏭️</button>
                        </div>
                        <label><input type="checkbox" id="sequential-read-checkbox" checked> 정주행</label>
                        <button id="clear-all-files-btn">전체 삭제</button>
                    </div>
                </div>
                
                <div class="text-viewer-section">
                    <!-- 모바일용 토글 버튼: 텍스트 뷰어 위에 위치 -->
                    <button id="mobile-toggle-btn" class="mobile-only toggle-btn">Right Panel 열기</button>
                    
                    <h2>텍스트 뷰어</h2>
                    <div class="mobile-only mobile-buttons">
                        <button id="mobile-file-upload-btn">파일첨부</button>
                        <button id="mobile-load-voice-btn">음성로드</button>
                    </div>
                    <div id="text-viewer" contenteditable="true">
                        <p>텍스트, 이미지 파일을 드래그하여 첨부하거나 텍스트/URL을 붙여넣어 오디오북으로 변환하세요. 텍스트를 수정하거나 내용을 직접 입력할 수도 있습니다.</p>
                        <p>첨부된 파일이 있으면 여기에 그 내용이 표시됩니다. OCR 진행 중인 이미지 파일은 여기에 OCR 결과가 표시될 예정입니다.</p>
                    </div>
                </div>
            </div> <!-- End of #left_panel -->

            <!-- PC용 토글 버튼: Left Panel과 Right Panel 사이에 위치 -->
            <button id="pc-toggle-btn" class="pc-only toggle-btn">
                <span class="icon">▶</span>
            </button>
            
            <div id="right_panel">
                <h2>추가 정보 (Right Panel)</h2>
                <div class="right-panel-content">
                    <p>이 패널은 PC 버전에서는 왼쪽 패널의 콘텐츠를 보조하며 오른쪽으로 확장됩니다.</p>
                    <p>모바일 버전에서는 전체 화면을 차지하게 됩니다.</p>
                    <p>토글 버튼을 다시 눌러 닫거나, 모바일에서는 상단의 버튼을 눌러 닫을 수 있습니다.</p>
                    <p>여기에 북마크, 노트, 추가 설정 등 보조 기능들을 배치할 수 있습니다.</p>
                </div>
            </div> <!-- End of #right_panel -->

        </div> <!-- End of .main-flex-container -->       
    </div>
    <script type="module" src="script.js"></script>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex))._csv;
                
                return csv;

            } catch (error) {
                console.error("Error reading XLSX file:", error);
                return '엑셀 파일을 읽는 중 오류가 발생했습니다.';
            }
        }
        return gk_fileData[filename];
        }
    </script>
</body>
</html>
